"use strict";((typeof self<"u"?self:this).webpackChunkMyLibrary=(typeof self<"u"?self:this).webpackChunkMyLibrary||[]).push([[6045],{29071:function(E,c,t){t.r(c)},40930:function(E,c,t){t.r(c)},31775:function(E,c,t){t.r(c)},68588:function(E,c,t){t.r(c)},29013:function(E,c,t){Object.defineProperty(c,"__esModule",{value:!0}),c.default=h,t(4064);function h(e){var T=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(T)return e.name;if(e!=null&&e.is_sql)return e.alias||e?.sql;if(e.alias)return e.alias;if(!e.name)return"";var o=e.name;return e!=null&&e.aggregate&&(o="".concat(e.aggregate,"(").concat(e.name,")"),e.aggregate==="DISCOUNT"&&(o="COUNT(DISTINCT ".concat(e.name,")"))),o}},71997:function(E,c,t){Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var h=t(30327),e=(0,h.defineStore)({id:"panelEditor",state:function(){return{panel:null}},actions:{savePanel(o){this.panel=o}}}),T=e;c.default=T},53232:function(E,c,t){var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e=t(70748),T=h(t(64375));t(88322),t(25528),t(58146),t(29071);var o=h(t(78310)),w=(0,e.defineComponent)({name:"CustomSwitch",props:{modelValue:{type:[Boolean,Number,String],default:!1},value:{type:[Boolean,Number,String],default:!1},isFlexChild:{type:Boolean,default:!1},showData:{type:Object,default:function(){return[{text:"\u5F00\u542F",value:!0},{text:"\u5173\u95ED",value:!1}]}},showText:{type:Array,default:function(){return[]}},backgroundColor:{type:String,default:"#fff"},activeBackgroundColor:{type:String,default:"#E1ECFF"},textColor:{type:String,default:"#63656E"},activeTextColor:{type:String,default:"#3A84FF"},itemWidth:{type:Number},activeBorderColor:{type:String,default:"#3A84FF"},borderColor:{type:String,default:"#C4C6CC"},height:{type:Number,default:26}},emits:["update:modelValue","change"],setup(m){var g=(0,e.ref)(m.modelValue||m.value),V=(0,e.ref)(0);return(0,e.watch)(function(){return[m.modelValue,m.value]},function(B){var p=(0,T.default)(B,2),S=p[0],L=p[1];g.value=S||L,V.value=m.showData.findIndex(function(r){return r.value===g.value})},{deep:!0,immediate:!0}),{val:g,activeIndex:V}},methods:{handleValueChange(m){this.activeIndex=m,this.val=this.showData[m].value,this.$emit("update:modelValue",this.val),this.$emit("change",this.val)}},render(){var m=this,g={width:"".concat(this.itemWidth?"".concat(this.itemWidth,"px"):"auto"),color:this.textColor,backgroundColor:this.backgroundColor,borderColor:this.borderColor},V={width:"".concat(this.itemWidth?"".concat(this.itemWidth,"px"):"auto"),color:this.activeTextColor,backgroundColor:this.activeBackgroundColor,borderColor:this.activeBorderColor};return(0,e.createVNode)("div",{class:"custom-switch",style:{height:"".concat(this.height,"px")}},[this.showData.length>0?this.showData.map(function(B,p){return(0,e.createVNode)("div",{class:(0,o.default)("custom-switch-button",{"pre-button":m.activeIndex-p===1,"active-button":m.activeIndex===p,"flex-1":m.isFlexChild}),style:m.val===B.value?V:g,key:p,onClick:function(){return m.handleValueChange(p)}},[m.showData.length<=2&&m.showText.length>0?m.showText[p]:B.text])}):"\u8BF7\u4F20\u5165\u6570\u636E"])}});c.default=w},13564:function(E,c,t){var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e=h(t(62530));t(41465);var T=e.default;c.default=T},56350:function(E,c,t){t(81821),t(34),t(84873),t(1714);var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0,t(6125),t(20148),t(50754),t(35340),t(14775),t(37209),t(2968),t(19903),t(3105),t(17777),t(58146);var e=h(t(64375)),T=h(t(65809)),o=h(t(63638)),w=t(35385),m=t(64210),g=t(70748),V=t(12692),B=h(t(63595)),p=t(92244),S=t(71633),L=t(29113),r=t(11016),j=t(39456),s=t(81133),C=h(t(55760)),F=t(22247),i=h(t(32869)),v=t(36473),D=h(t(71997));function A(O,l){var n=Object.keys(O);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(O);l&&(a=a.filter(function(u){return Object.getOwnPropertyDescriptor(O,u).enumerable})),n.push.apply(n,a)}return n}function N(O){for(var l=1;l<arguments.length;l++){var n=arguments[l]!=null?arguments[l]:{};l%2?A(Object(n),!0).forEach(function(a){(0,o.default)(O,a,n[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(O,Object.getOwnPropertyDescriptors(n)):A(Object(n)).forEach(function(a){Object.defineProperty(O,a,Object.getOwnPropertyDescriptor(n,a))})}return O}var U=(0,D.default)(),y=class extends(0,m.TSX)()(m.Vue){constructor(){super(...arguments),(0,o.default)(this,"panelModel",void 0),(0,o.default)(this,"expendList",[!0,!0]),(0,o.default)(this,"loading",!0),(0,o.default)(this,"loadingColumns",!0),(0,o.default)(this,"error",{type:"empty",msg:""}),(0,o.default)(this,"tableList",[]),(0,o.default)(this,"tableColumns",{}),(0,o.default)(this,"storage",{}),(0,o.default)(this,"formData",[]),(0,o.default)(this,"envs",[{id:"preview",name:"\u9884\u89C8\u73AF\u5883"},{id:"stag",name:"\u9884\u53D1\u5E03\u73AF\u5883"},{id:"prod",name:"\u751F\u4EA7\u73AF\u5883"}])}changePanelChartType(l){l==="time-series-mixed"?this.panelModel.query.length<2&&this.addQuery():this.panelModel.query.length>1&&this.formData.splice(1,1)}get chartMeta(){var l=this;return s.ChartSourceModule.chartSourceList.find(function(n){return n.id===l.panelModel.type})}created(){this.init()}init(){this.initData()}initData(){var l=this;return(0,T.default)(regeneratorRuntime.mark(function n(){return regeneratorRuntime.wrap(function(u){for(;;)switch(u.prev=u.next){case 0:l.getTables(l.panelModel.datasource.uid).then(function(){var x;if(l.formData=[],l.expendList=[],l.formData=l.panelModel.query,l.panelModel.datasource&&(x=l.panelModel.query)!==null&&x!==void 0&&x.length&&U.panel.datasource.uid===l.panelModel.datasource.uid){for(var f=0;f<l.panelModel.query.length;f++)if(l.panelModel.query[f]){var Q=l.panelModel.query[f].table;l.panelModel.query[f].ref_id||(l.panelModel.query[f].ref_id=S.Letters[f]),Q&&(l.panelModel.datasource.type==="bkbase"&&l.getStorage(Q,f),l.getColumnsData(Q)),l.expendList.push(!0)}}else l.addQuery();l.panelModel.type==="time-series-mixed"&&l.panelModel.query.length<2&&(l.addQuery(),l.expendList=[!0,!0])}).finally(function(){l.loading=!1});case 1:case"end":return u.stop()}},n)}))()}addFormData(l){var n=v.DataSourceModule.datasourceMap.get(this.panelModel.datasource.type),a=n?.QueryConfig||V.QueryMysqlSimpleClass;return console.log(new a(l)),new a(l)}addQuery(){var l=this,n=S.Letters[this.formData.length],a=window.location.search.substr(1),u=B.default.parse(a),x=u.datasouce_table,f=this.addFormData(n);x&&(f.table=String(x),(0,g.nextTick)(function(){l.getColumns(0,f.table)})),this.formData.push(f),this.expendList.splice(this.formData.length,0,!0)}copyQuery(l,n){l.stopPropagation();var a=(0,L.deepClone)(n);a.ref_id=String.fromCharCode(97+this.formData.length).toUpperCase(),this.formData.push(a),this.expendList.splice(this.formData.length,0,!0)}deleteQuery(l,n){var a=this;l.stopPropagation(),console.log(n),(0,i.default)("\u63D0\u793A","\u786E\u8BA4\u8981\u5220\u9664",function(){a.formData.splice(n,1),a.expendList.splice(n,1);for(var u=0;u<a.formData.length;u++)a.formData[u].ref_id=String.fromCharCode(97+u).toUpperCase()})}getTables(l){var n=this;return this.error.msg="",this.loading=!0,(0,p.getTablesList)(l).then(function(a){n.tableList=a.map(function(u){return{value:u,label:u}})}).catch(function(a){n.error.msg=a?.message||"\u8BF7\u6C42\u51FA\u9519",n.error.type="500"})}getColumns(l,n){var a;!n||(((a=this.panelModel.datasource)===null||a===void 0?void 0:a.type)==="bkbase"&&this.getStorage(n,l),this.getColumnsData(n))}getColumnsData(l){var n=this;this.tableColumns[l]||(this.loadingColumns=!0,this.tableColumns[l]=[],(0,p.getTableColumns)(this.panelModel.datasource.uid,l).then(function(a){n.tableColumns[l]=a}).catch(function(a){n.tableColumns[l]=null,(0,F.Message)({theme:"error",message:a?.message||"\u52A0\u8F7D\u5B57\u6BB5\u5931\u8D25"})}).finally(function(){n.loadingColumns=!1}))}getStorage(l,n){var a=this;Object.prototype.hasOwnProperty.call(this.storage,l)||(0,p.getBkBaseStorage)(l).then(function(u){a.storage[l]=u.map(function(f){return{id:f,name:f}});var x=(0,e.default)(u,1);a.formData[n].storage=x[0]})}changeSqlModel(l,n){if(n){var a;l.raw_query=n;var u;if(l.time_filter.field&&l.time_filter.type==="datetime"){var x=this.formData[0].time_filter;u=x.category==="fixed"?[x.range.from,x.range.to]:j.QueryContextModule.timeRange}else u=j.QueryContextModule.timeRange;var f=(0,r.getTimeRange)(u),Q=(0,e.default)(f,2),$=Q[0],H=Q[1],b=j.QueryContextModule.variables;(0,p.renderSql)({query:N(N({},l),{},{datasource:{type:this.panelModel.datasource.type,uid:this.panelModel.datasource.uid},format:((a=this.chartMeta)===null||a===void 0?void 0:a.data_type)||l.format}),option:{range:{from:$,to:H,raw:{from:u[0],to:u[1]},datetime_str:{from:(0,C.default)($).format("YYYY-MM-DD HH:mm:ss"),to:(0,C.default)(H).format("YYYY-MM-DD HH:mm:ss")}},variables:b}}).then(function(d){l.query_text=d}).catch(function(d){(0,F.Message)({theme:"error",message:d?.message||"\u6E32\u67D3sql\u51FA\u9519"}),l.query_text="select * from xxx"})}else(0,i.default)("\u5207\u6362\u7B80\u6613\u6A21\u5F0F","\u5207\u6362\u56DE\u7B80\u6613\u6A21\u5F0F\u5C06\u6E05\u9664\u60A8\u6240\u505A\u7684\u4EFB\u4F55\u6539\u52A8\uFF0C\u662F\u5426\u7EE7\u7EED\uFF1F",function(){l.raw_query=n})}};(0,w.__decorate)([(0,m.Prop)()],y.prototype,"panelModel",void 0),(0,w.__decorate)([(0,m.Watch)("panelModel.type")],y.prototype,"changePanelChartType",null),y=(0,w.__decorate)([m.ComponentBase],y);var M=y;c.default=M},84875:function(E,c,t){var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e=t(70748);t(34),t(37209),t(99057),t(14827),t(9100),t(58146);var T=t(12692),o=t(22247),w=t(14712),m=h(t(78310)),g=t(95939),V=t(2769),B=h(t(29013)),p=o.Tab.TabPanel,S=o.Radio.Group,L=(0,e.defineComponent)({name:"QueryTargetInput",props:{modelValue:{type:Object,default:function(){return new T.QueryColumn}},aliasList:{type:Array,default:function(){return[]}},type:{type:String,default:""},renderType:{type:String,default:""},list:{type:Array,default:function(){return[]}}},emits:["change","update:modelValue","add","remove"],setup(r,j){var s=j.emit,C=(0,e.ref)("normal"),F=(0,e.ref)(null),i=(0,e.ref)(""),v=(0,e.ref)(!1),D=(0,e.ref)(""),A=(0,e.ref)(!1),N=(0,e.ref)(new T.QueryColumn(r.modelValue)),U=(0,e.computed)(function(){return(0,g.getAggregationOptions)(N.value.type)});(0,e.watch)(function(){return r.modelValue},function(b){N.value=new T.QueryColumn(b)},{deep:!0}),(0,e.watch)(function(){return C.value},function(b){N.value.is_sql=b==="sql"});var y=(0,e.ref)((0,B.default)(N.value)),M=(0,e.computed)(function(){var b;return r.renderType==="targets"?b=r.list:b=r.list.filter(function(d){return d.type!=="f(x)"}),D.value?b.filter(function(d){var P=d.name;return String(P).toLowerCase().includes(String(D.value).toLowerCase())}):b}),O=(0,e.computed)(function(){if(r.type==="add"){if(N.value.is_sql){if(!N.value.sql)return!0}else if(!N.value.name)return!0}return!1});function l(){if(r.type==="add"){s("add",(0,V.cloneDeep)(N.value)),a();return}y.value=(0,B.default)(N.value),s("update:modelValue",N.value),Object.assign(r.modelValue,(0,V.cloneDeep)(N.value)),s("change",N.value),n()}function n(){H(),F.value.hide()}function a(){n(),N.value=new T.QueryColumn(r.modelValue)}function u(b){var d=b.isShow;d.value=d}function x(b){var d=b.type,P=b.name;N.value.name=P,N.value.type=d,console.log(d,P,N.value)}function f(){s("remove")}function Q(){A.value=!0,i.value=N.value.alias}function $(){if(N.value.alias===i.value){A.value=!1;return}if(i.value&&r.aliasList.length&&r.aliasList.includes(i.value)){(0,o.Message)({theme:"error",message:"\u522B\u540D\u91CD\u590D\uFF0C\u8BF7\u91CD\u547D\u540D"});return}N.value.alias=i.value,A.value=!1}function H(){A.value=!1,i.value=""}return{isShow:v,targetName:y,disableEnsure:O,formData:N,active:C,keyword:D,options:M,aggregationOptions:U,isInputName:A,aliasName:i,popoverRef:F,ensure:l,cancel:a,handleAfterHidden:u,changeColumn:x,remove:f,setAlias:Q,cancelAlias:H,ensureAlias:$}},render(){var r=this;return(0,e.createVNode)("div",{class:"dragging-handle"},[(0,e.createVNode)(o.Popover2,{ref:"popoverRef",isShow:this.isShow,"on-after-hidden":this.handleAfterHidden,trigger:"click",theme:"light bv-target-popover",placement:"bottom-start",height:342},{default:function(){return r.type==="add"?(0,e.createVNode)("div",{class:"bv-target-add-btn"},[(0,e.createVNode)(w.Plus,null,null)]):(0,e.createVNode)("div",{class:"bv-target-input"},[(0,e.createVNode)("div",{class:"bv-target-input-text"},[(0,e.createVNode)("div",{class:"text-ov"},[r.targetName])]),(0,e.createVNode)("div",{class:"bv-target-input-btn flex-row align-items-center"},[(0,e.createVNode)("i",{onClick:r.remove,class:"bkvision-icon icon-guanbi_mianxing"},null)])])},content:function(){var s;return(0,e.createVNode)("div",{class:"full-height flex-column"},[(0,e.createVNode)(o.Tab,{class:"bk-tab-flex bv-target-tab  bv-target-has-alias full-height overflow-auto",active:r.active,"onUpdate:active":function(F){return r.active=F},"label-height":38,type:"unborder-card"},{default:function(){return[(0,e.createVNode)(p,{label:"\u666E\u901A\u6A21\u5F0F",name:"normal"},{default:function(){return[(0,e.createVNode)("div",{class:"flex-row full-height pt-min"},[(0,e.createVNode)("div",{class:"bv-target-select flex-column full-height flex-1"},[(0,e.createVNode)("div",{class:"flex-row align-items-center justify-content-between mb-min"},[(0,e.createVNode)("strong",{class:" pl-normal pr-xxl text-ov"},[(0,e.createTextVNode)("\u5B57\u6BB5\u9009\u62E9")]),(0,e.createVNode)("div",{class:(0,m.default)("bv-target-search flex-row align-items-center",{"bv-target-search-active":r.keyword})},[(0,e.createVNode)(o.Input,{modelValue:r.keyword,"onUpdate:modelValue":function(v){return r.keyword=v},behavior:"simplicity",clearable:!0,placeholder:"\u641C\u7D22",size:"small"},{suffix:function(){return(0,e.createVNode)("span",{class:"input-icon"},[(0,e.createVNode)(w.Search,null,null)])}})])]),(0,e.createVNode)("div",{class:"flex-1 overflow-auto"},[(0,e.createVNode)("div",{class:"full-height overflow-auto"},[(s=r.options)!==null&&s!==void 0&&s.length?r.options.map(function(i){var v;return(0,e.createVNode)("div",{key:i.name,onClick:function(){return r.changeColumn(i)},class:(0,m.default)("bv-target-item flex-row align-items-center justify-content-between",{"bv-target-item-active":((v=r.formData)===null||v===void 0?void 0:v.name)===i.name})},[(0,e.createVNode)("div",{class:"flex-1 mr-normal text-ov"},[i.name]),(0,e.createVNode)("div",null,[i.type])])}):(0,e.createVNode)(o.Exception,{class:"full-height  align-items-center justify-content-center",scene:"part",type:"empty"},null)])])]),r.renderType==="targets"?(0,e.createVNode)("div",{class:"bv-target-radio-box flex-column full-height"},[(0,e.createVNode)("div",{class:"bv-target-radio-title"},[(0,e.createTextVNode)("\u805A\u5408\u51FD\u6570 (\u53EF\u9009)")]),(0,e.createVNode)(S,{modelValue:r.formData.aggregate,"onUpdate:modelValue":function(v){return r.formData.aggregate=v}},{default:function(){return[(0,e.createVNode)("div",{class:"flex-1 overflow-auto "},[r.aggregationOptions.map(function(v,D){return(0,e.createVNode)("div",{class:"pb-small",key:v.id+D},[(0,e.createVNode)(o.Radio,{label:v.id},{default:function(){return[v.name]}})])}),(0,e.createVNode)("div",{class:"pb-small"},[(0,e.createVNode)(o.Radio,{label:""},{default:function(){return[(0,e.createTextVNode)("\u65E0")]}})])])]}})]):""])]}}),(0,e.createVNode)(p,{label:"\u81EA\u5B9A\u4E49SQL",name:"sql"},{default:function(){return[(0,e.createVNode)("div",{class:"full-height p-normal"},[(0,e.createVNode)(o.Input,{modelValue:r.formData.sql,"onUpdate:modelValue":function(v){return r.formData.sql=v},placeholder:r.formData.name,type:"textarea",class:"full-height"},null)])]}})]},setting:function(){return r.isInputName?(0,e.createVNode)("div",{class:"flex-1 flex-row align-items-center"},[(0,e.createVNode)(o.Input,{class:"flex-1",behavior:"simplicity",style:"width:160px;",size:"small",placeholder:"\u8BF7\u8F93\u5165",clearable:!0,maxlength:20,modelValue:r.aliasName,"onUpdate:modelValue":function(i){return r.aliasName=i}},null),(0,e.createVNode)("div",{class:"flex-row align-items-center"},[(0,e.createVNode)(o.Button,{text:!0,theme:"success",onClick:r.ensureAlias},{default:function(){return[(0,e.createVNode)("i",{class:"font-large bkvision-icon icon-check-small mr-min"},null)]}}),(0,e.createVNode)(o.Button,{text:!0,onClick:r.cancelAlias},{default:function(){return[(0,e.createVNode)("i",{class:"font-large bkvision-icon icon-close-small mr-min"},null)]}})])]):(0,e.createVNode)("div",{class:"text-link cursor-pointer font-small text-ov mr-xl",style:"max-width:180px;",onClick:r.setAlias},[r.formData.alias?"".concat(r.formData.alias):(0,e.createVNode)(e.Fragment,null,[(0,e.createVNode)("i",{class:"bkvision-icon icon-bianji"},null),(0,e.createTextVNode)("\u5B57\u6BB5\u522B\u540D")])])}}),(0,e.createVNode)("div",{class:"bv-target-footer flex-row justify-content-end align-items-center"},[(0,e.createVNode)(o.Button,{onClick:r.ensure,disabled:r.disableEnsure,size:"small",theme:"primary",class:"mr-normal"},{default:function(){return[(0,e.createTextVNode)("\u786E\u5B9A")]}}),(0,e.createVNode)(o.Button,{onClick:r.cancel,size:"small"},{default:function(){return[(0,e.createTextVNode)("\u53D6\u6D88")]}})])])}})])}});c.default=L},76948:function(E,c,t){var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0;var e=t(70748);t(58146),t(35340);var T=t(22247),o=h(t(84875)),w=h(t(19291));t(40930);var m=T.Form.FormItem,g=(0,e.defineComponent)({name:"QueryTargets",props:{modelValue:{type:Array,default:function(){return[]}},type:{type:String,default:""},renderType:{type:String,default:""},list:{type:Array,default:[]}},emits:["change","update:modelValue"],setup(V,B){var p=B.emit,S=(0,e.computed)({get:function(){return V.modelValue},set:function(C){return p("update:modelValue",C)}}),L=(0,e.computed)(function(){return S.value.map(function(s){return s.alias})});function r(s){S.value.push(s)}function j(s){S.value.splice(s,1)}return{formData:S,aliasList:L,add:r,remove:j}},render(){var V=this;return(0,e.createVNode)(m,{required:this.renderType==="targets",label:this.renderType==="targets"?this.$t("\u6307\u6807"):this.$t("\u7EF4\u5EA6"),class:"bv-form-item-wrap"},{default:function(){return[(0,e.createVNode)(w.default,{list:V.formData,handle:".dragging-handle",tag:"div","item-key":"name",class:"flex-row align-items-center flex-wrap"},{item:function(S){var L=S.element,r=S.index;return(0,e.createVNode)(o.default,{key:L.name+r,modelValue:L,"onUpdate:modelValue":function(s){return L=s},onRemove:function(){return V.remove(r)},renderType:V.renderType,list:V.list,aliasList:V.aliasList},null)},footer:function(){return(0,e.createVNode)(o.default,{type:"add",onAdd:V.add,renderType:V.renderType,list:V.list,aliasList:V.aliasList},null)}})]}})}});c.default=g},5642:function(E,c,t){var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0,t(34),t(37209),t(14775),t(58146);var e=t(70748),T=h(t(64375)),o=t(22247),w=t(95939);t(31775);var m=t(11016),g=h(t(55760));function V(r){return typeof r=="function"||Object.prototype.toString.call(r)==="[object Object]"&&!(0,e.isVNode)(r)}var B=o.Form.FormItem,p=o.Select.Option,S="YYYY-MM-DD HH:mm:ss",L=(0,e.defineComponent)({name:"QueryTime",props:{modelValue:{type:Object,default:[]},list:{type:Array,default:[]},handleTimeRangeChange:{type:Function},getTimeRangeFromFilter:{type:Function}},emits:["change","update:modelValue"],setup(r,j){var s=j.emit,C=(0,e.computed)({get:function(){return r.modelValue},set:function(y){return s("update:modelValue",y)}}),F=(0,e.computed)({get:function(){var y=C.value.range,M=y.from,O=y.to;return[M,O].join("--")},set:function(y){var M=y.split("--"),O=(0,T.default)(M,2),l=O[0],n=O[1];C.value.range={from:l,to:n}}}),i=(0,e.shallowRef)([(0,g.default)().startOf("d").toDate(),new Date]),v=(0,e.computed)(function(){return r.list.filter(function(U){return!!w.TIME_TYPE.find(function(y){var M;return y.toLowerCase()===((M=U.type)===null||M===void 0?void 0:M.toLowerCase())})})});function D(U){switch(U){case"fixed":{i.value=[(0,g.default)().startOf("d").toDate(),new Date];var y=(0,T.default)(i.value,2),M=y[0],O=y[1];C.value.range={from:(0,g.default)(M).format(S),to:(0,g.default)(O).format(S)}}break;case"dynamic_fixed":C.value.range={from:"now/d",to:"now/d"};break;default:C.value.range={from:"now/d",to:"now/d"};break}}function A(U){var y=(0,T.default)(U,2),M=y[0],O=y[1];C.value.range={from:(0,g.default)(M).format(S),to:(0,g.default)(O).format(S)}}function N(U){U||(C.value.field="");var y=v.value.find(function(M){return M.name===U});C.value.type=y.type}return{formData:C,options:v,timeRangeStr:F,timeRangeDate:i,changeCategory:D,changeDate:A,changeColumn:N}},render(){var r,j,s=this,C=function(){var i;switch(s.formData.category){case"fixed":return(0,e.createVNode)(o.DatePicker,{onChange:s.changeDate,modelValue:s.timeRangeDate,"onUpdate:modelValue":function(D){return s.timeRangeDate=D},class:"full-width",format:"yyyy-MM-dd HH:mm:ss",type:"daterange",placeholder:"\u9009\u62E9\u65E5\u671F\u8303\u56F4",clearable:!1},null);case"dynamic_fixed":return(0,e.createVNode)(o.Select,{class:"full-width",modelValue:s.timeRangeStr,"onUpdate:modelValue":function(D){return s.timeRangeStr=D},clearable:!1},V(i=m.SHORTCUTS.map(function(v,D){return(0,e.createVNode)(p,{label:v.text,value:v.short.join("--"),key:D},null)}))?i:{default:function(){return[i]}});default:return""}};return(0,e.createVNode)(B,{label:"\u65F6\u95F4"},{default:function(){return[(0,e.createVNode)("div",{class:"flex-row  align-items-center"},[(0,e.createVNode)("div",{class:"bv-query-time-select  flex-row align-items-center"},[(0,e.createVNode)("div",{class:"target-select-set"},[(0,e.createTextVNode)("\u65F6\u95F4\u5B57\u6BB5")]),(0,e.createVNode)(o.Select,{placeholder:s.$t("\u8BF7\u9009\u62E9\u65F6\u95F4\u5B57\u6BB5"),modelValue:s.formData.field,"onUpdate:modelValue":function(v){return s.formData.field=v},onChange:s.changeColumn,filterable:!0,allowCreate:!0,popoverMinWidth:268,class:"flex-1"},V(r=s.options.map(function(i){return(0,e.createVNode)(p,{label:i.name,key:i.name,value:i.name},{default:function(){return[(0,e.createVNode)("div",{class:"flex-row align-items-center justify-content-between"},[(0,e.createVNode)("div",{class:"flex-1 text-ov mr-normal"},[i.name]),(0,e.createVNode)("div",{style:{fontSize:".8em"}},[i.type])])]}})}))?r:{default:function(){return[r]}})]),s.formData.field?(0,e.createVNode)("div",{class:"bv-query-time-select flex-row align-items-center"},[(0,e.createVNode)("div",{class:"target-select-set"},[(0,e.createTextVNode)("\u805A\u5408\u89C4\u5219")]),(0,e.createVNode)(o.Select,{modelValue:s.formData.aggregate,"onUpdate:modelValue":function(v){return s.formData.aggregate=v},filterable:!0,clearable:!1,class:"flex-1"},V(j=w.TimeAggregateList.map(function(i){return(0,e.createVNode)(p,{key:i.id,value:i.id,label:i.name},null)}))?j:{default:function(){return[j]}})]):""]),s.formData.field?(0,e.createVNode)("div",{class:"flex-row  align-items-center mt-normal"},[(0,e.createVNode)("div",{class:"bv-query-time-select flex-row align-items-center"},[(0,e.createVNode)("div",{class:"target-select-set"},[(0,e.createTextVNode)("\u65F6\u95F4\u8303\u56F4")]),(0,e.createVNode)(o.Select,{modelValue:s.formData.category,"onUpdate:modelValue":function(v){return s.formData.category=v},onChange:s.changeCategory,filterable:!0,clearable:!1,class:"flex-1"},{default:function(){return[(0,e.createVNode)(p,{value:"dynamic",label:"\u8DDF\u968F\u5168\u5C40\u65F6\u95F4\u9009\u62E9\u5668"},null),(0,e.createVNode)(p,{value:"fixed",label:"\u56FA\u5B9A\u65F6\u95F4\u8303\u56F4"},null),(0,e.createVNode)(p,{value:"dynamic_fixed",label:"\u52A8\u6001\u8303\u56F4"},null),(0,e.createVNode)(p,{value:"no limit",label:"\u4E0D\u9650\u5236\u8303\u56F4"},null)]}})]),(0,e.createVNode)("div",{class:"flex-row align-items-center",style:"width:318px;"},[C()])]):""]}})}});c.default=L},11817:function(E,c,t){t(81821),t(84873),t(1714);var h=t(38600);Object.defineProperty(c,"__esModule",{value:!0}),c.default=void 0,t(6125),t(20148),t(50754),t(58146),t(34),t(37209),t(35340);var e=t(70748),T=h(t(65809)),o=h(t(63638)),w=t(35385),m=t(64210),g=t(22247),V=t(14712),B=h(t(53232)),p=h(t(13564)),S=t(12692),L=t(92244),r=h(t(76948)),j=h(t(5642)),s=h(t(56350)),C=t(95939);t(68588);var F=h(t(71997));function i(l,n){var a=Object.keys(l);if(Object.getOwnPropertySymbols){var u=Object.getOwnPropertySymbols(l);n&&(u=u.filter(function(x){return Object.getOwnPropertyDescriptor(l,x).enumerable})),a.push.apply(a,u)}return a}function v(l){for(var n=1;n<arguments.length;n++){var a=arguments[n]!=null?arguments[n]:{};n%2?i(Object(a),!0).forEach(function(u){(0,o.default)(l,u,a[u])}):Object.getOwnPropertyDescriptors?Object.defineProperties(l,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach(function(u){Object.defineProperty(l,u,Object.getOwnPropertyDescriptor(a,u))})}return l}function D(l){return typeof l=="function"||Object.prototype.toString.call(l)==="[object Object]"&&!(0,e.isVNode)(l)}var A=(0,F.default)(),N=g.Form.FormItem,U=g.Select.Option,y=g.Tab.TabPanel,M=class extends(0,m.TSX)()(s.default){constructor(){super(...arguments),(0,o.default)(this,"formData",[]),(0,o.default)(this,"methods",["POST","GET"]),(0,o.default)(this,"formats",["JSONPath","JSONata"]),(0,o.default)(this,"panelModel",void 0)}formatFormData(){return this.formData.map(function(n){return v(v({},n),{},{headers:n.headers.filter(function(a){return a.key}),params:n.params.filter(function(a){return a.key}),targets:n.targets.filter(function(a){return a.name}),dimensions:n.dimensions.filter(function(a){return a.name}),order:n.order.filter(function(a){return!!a.name})})})}addFormData(n){return new S.JsonApiQueryConfig(n)}initData(){var n=this;return(0,T.default)(regeneratorRuntime.mark(function a(){var u,x,f;return regeneratorRuntime.wrap(function($){for(;;)switch($.prev=$.next){case 0:if(n.formData=[],n.expendList=[],n.formData=n.panelModel.query,n.panelModel.datasource&&(u=n.panelModel.query)!==null&&u!==void 0&&u.length&&A.panel.datasource.uid===n.panelModel.datasource.uid)for(x=0;x<n.panelModel.query.length;x++)f=n.panelModel.query[x],f&&(f.ref_id||(f.ref_id=C.Letters[x]),f.jsonpath&&n.handleJsonPathChange(f.jsonpath,f.ref_id,f.path),n.expendList.push(n.expendList.length));else n.addQuery();case 4:case"end":return $.stop()}},a)}))()}addOption(n,a,u){if(u.name){var x=this.formData[a][n].some(function(f){return n==="params"||n==="headers"?f.key===u.key:f.name===u.name});if(x){(0,g.Message)({message:"\u5DF2\u7ECF\u5B58\u5728\u4E0E\u6B64\u9879\u4E2D",theme:"error"});return}}this.formData[a][n].push(u)}deleteOption(n,a,u){this.formData[a][n].splice(u,1)}handleJsonPathChange(n,a,u){var x=this,f;typeof n=="string"?f=n:f=n.target.value,f&&(0,L.getTableColumns)(this.panelModel.datasource.uid,f,u).then(function(Q){x.tableColumns[a]=Q})}render(){var n,a=this,u=function(d){return(0,e.createVNode)("div",{class:"data-source-form  flex-row"},[(0,e.createVNode)("p",{class:"source-form-label flex-row align-items-center  flex-shrink-0"},[a.$t("\u5217\u8868\u5B57\u6BB5"),(0,e.createTextVNode)("\uFF08\u5FC5\u586B\uFF09")]),(0,e.createVNode)("div",{class:"source-form-item flex-row flex-grow-1 align-items-center flex-wrap"},[(0,e.createVNode)(g.Input,{class:"mr-min flex-grow-1",style:{minWidth:"150px",maxWidth:"500px"},modelValue:d.jsonpath,"onUpdate:modelValue":function(Y){return d.jsonpath=Y},placeholder:"$items[*].name",onBlur:function(Y){return a.handleJsonPathChange(Y,d.ref_id,d.path)}},null)])])},x=function(d,P){return(0,e.createVNode)(y,{name:"fields",label:a.$t("\u8FD4\u56DE\u5B57\u6BB5")},{default:function(){return[(0,e.createVNode)("div",null,[u(d),(0,e.createVNode)(r.default,{isJsonApi:!0,dict:a.dict,queryMode:a.dataSourceQueryMode,renderType:"targets",list:a.tableColumns,modelValue:d,"onUpdate:modelValue":function(I){return d=I},queryIndex:P},null),(0,e.createVNode)(r.default,{isJsonApi:!0,queryMode:a.dataSourceQueryMode,renderType:"dimensions",dict:a.dict,list:a.tableColumns,modelValue:d,"onUpdate:modelValue":function(I){return d=I},queryIndex:P},null),(0,e.createVNode)(j.default,{list:a.tableColumns,modelValue:d,"onUpdate:modelValue":function(I){return d=I},changeWhereItemType:a.changeWhereItemType,getTimeRangeFromFilter:a.getTimeRangeFromFilter,handleTimeRangeChange:a.handleTimeRangeChange},null)])]}})},f=function(d){var P;return(0,e.createVNode)(y,{name:"path",label:a.$t("\u8BF7\u6C42\u8DEF\u5F84")},{default:function(){return[(0,e.createVNode)("div",{class:"flex-row align-items-end"},[(0,e.createVNode)(g.Select,{inputSearch:!1,modelValue:d.method,"onUpdate:modelValue":function(I){return d.method=I},class:"mr-min"},D(P=a.methods.map(function(R){return(0,e.createVNode)(U,{value:R,label:R,key:R},null)}))?P:{default:function(){return[P]}}),(0,e.createVNode)(g.Input,{modelValue:d.path,"onUpdate:modelValue":function(I){return d.path=I},placeholder:"\u8BF7\u6C42\u8DEF\u5F84",class:"flex-1"},null)])]}})},Q=function(d,P,Y,R){return(0,e.createVNode)(y,{name:R,label:a.$t(Y)},{default:function(){return[(0,e.createVNode)("div",null,[d[R].map(function(J,z){return(0,e.createVNode)("div",{class:"flex-row mb-min  align-items-end",key:z},[(0,e.createVNode)(N,{label:"\u952E",class:"flex-1 mr-min"},{default:function(){return[(0,e.createVNode)(g.Input,{modelValue:J.key,"onUpdate:modelValue":function(W){return J.key=W}},null)]}}),(0,e.createVNode)(N,{label:"\u503C",class:"flex-1"},{default:function(){return[(0,e.createVNode)(g.Input,{modelValue:J.value,"onUpdate:modelValue":function(W){return J.value=W}},null)]}}),(0,e.createVNode)("div",{class:"item-button delete-button ml-min flex-row align-items-center justify-content-center",onClick:function(){return a.deleteOption(R,P,z)}},[(0,e.createVNode)(V.Del,null,null)])])}),(0,e.createVNode)("div",{class:"item-button add-button flex-row align-items-center justify-content-center",onClick:function(){return a.addOption(R,P,{key:"",value:""})}},[(0,e.createVNode)(V.Plus,null,null)])])]}})},$=function(d){return(0,e.createVNode)(y,{name:"body",renderDirective:"if",label:a.$t("\u8BF7\u6C42\u4F53")},{default:function(){return[(0,e.createVNode)("div",null,[(0,e.createVNode)(B.default,{class:"mb-min",modelValue:d.body.format,"onUpdate:modelValue":function(R){return d.body.format=R},showData:[{text:"\u6587\u672C",value:"text"},{text:"JSON",value:"json"}]},null),(0,e.createVNode)(N,{property:"body.content",style:{width:"100%"}},{default:function(){return[(0,e.createVNode)(p.default,{height:"200",theme:"vs-dark",language:d.body.format==="text"?"plaintext":d.body.format,modelValue:d.body.content,"onUpdate:modelValue":function(I){return d.body.content=I}},null)]}})])]}})},H=function(d,P){return(0,e.createVNode)("div",{class:""},[(0,e.createVNode)("div",{class:"flex-row align-items-center justify-content-between"},[(0,e.createVNode)("p",{style:{height:"100%",lineHeight:"30px"}},[d.ref_id])]),(0,e.createVNode)("div",null,[(0,e.createVNode)(g.Tab,{type:"border-card"},{default:function(){return[x(d,P),f(d),Q(d,P,"\u8BF7\u6C42\u53C2\u6570","params"),Q(d,P,"\u8BF7\u6C42\u5934","headers"),$(d)]}})])])};return(0,e.createVNode)("div",{class:"data-source-query json-api-datasource"},[(0,e.createVNode)("div",{class:"flex-1"},[(0,e.createVNode)(g.Form,{"form-type":"vertical",class:"data-source-select",model:this.formData},D(n=this.formData.map(function(b,d){return H(b,d)}))?n:{default:function(){return[n]}})])])}};(0,w.__decorate)([(0,m.Prop)()],M.prototype,"panelModel",void 0),(0,w.__decorate)([(0,m.Emit)("formatFormData")],M.prototype,"formatFormData",null),M=(0,w.__decorate)([m.Component],M);var O=M;c.default=O}}]);
